# 使用者流程圖

## 完整流程圖

```
┌─────────────────────────────────────────────────────────────┐
│                        啟動應用程式                          │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  步驟 1: 輸入銀行編號                                        │
│  [輸入框: 101] [獲取登入資訊 按鈕]                           │
└─────────────────────────────────────────────────────────────┘
                            ↓
                  點擊「獲取登入資訊」
                            ↓
                   ┌─────────────┐
                   │  呼叫 API   │
                   └─────────────┘
                   ↙            ↘
            API 成功             API 失敗
                ↓                    ↓
    ┌──────────────────────┐   ┌──────────────────────┐
    │  方式 A: API 模式    │   │  方式 B: 手動模式    │
    └──────────────────────┘   └──────────────────────┘
                ↓                    ↓
    ┌──────────────────────┐   ┌──────────────────────┐
    │ 顯示銀行資訊面板：    │   │ 顯示手動輸入面板：    │
    │ • 銀行名稱           │   │ ⚠️ API 查詢失敗      │
    │ • 統編               │   │                     │
    │ • 使用者代號         │   │ [銀行代號▼] bot     │
    │ • 設定檔             │   │ [公司統編]          │
    │                     │   │ [使用者帳號]        │
    │ [開始執行自動化]     │   │ [使用者密碼]        │
    └──────────────────────┘   │                     │
                              │ [使用手動輸入開始]   │
                              │ [取消]              │
                              └──────────────────────┘
                ↓                    ↓
                └────────┬───────────┘
                         ↓
            ┌─────────────────────────┐
            │  設定查詢天數（0-90天）  │
            └─────────────────────────┘
                         ↓
                點擊「開始」按鈕
                         ↓
    ┌─────────────────────────────────────────────┐
    │  Puppeteer 啟動 Chrome 瀏覽器               │
    │  • 開啟銀行登入頁面                          │
    │  • 自動填寫統編、帳號、密碼                  │
    └─────────────────────────────────────────────┘
                         ↓
    ┌─────────────────────────────────────────────┐
    │  ⏸️  等待使用者手動輸入驗證碼（4 位數）       │
    └─────────────────────────────────────────────┘
                         ↓
              驗證碼輸入完成（4 位數）
                         ↓
    ┌─────────────────────────────────────────────┐
    │  🤖 完全自動執行（無需人工介入）             │
    │                                             │
    │  ✅ 自動點擊登入按鈕                         │
    │  ✅ 等待登入成功（偵測 URL 變更）            │
    │  ✅ 等待 MainFrame 載入完成                 │
    │  ✅ 步驟 1: 導航到帳務查詢                   │
    │  ✅ 步驟 2: 點擊存款帳戶                     │
    │  ✅ 步驟 3: 點擊交易明細查詢                 │
    │  ✅ 步驟 4: 設定查詢日期範圍                 │
    │  ✅ 步驟 5: 執行查詢                        │
    │  ✅ 步驟 6: 提取交易資料                    │
    └─────────────────────────────────────────────┘
                         ↓
    ┌─────────────────────────────────────────────┐
    │  📊 顯示結果                                │
    │  • 日誌：成功提取 X 筆交易紀錄               │
    │  • 回傳資料到後端 API（未來實作）            │
    └─────────────────────────────────────────────┘
                         ↓
                    執行完成 ✅
```

## 使用情境說明

### 情境 1: API 正常運作（推薦）

```
使用者輸入銀行編號 101
    ↓
點擊「獲取登入資訊」
    ↓
API 回傳資料成功
    ↓
自動顯示：
  - 銀行名稱: 臺灣銀行
  - 統編: 50660688
  - 使用者代號: locker1688
    ↓
點擊「開始執行自動化」
    ↓
系統開始運作...
```

### 情境 2: API 失敗（備援模式）

```
使用者輸入銀行編號 101
    ↓
點擊「獲取登入資訊」
    ↓
❌ API 失敗（網路問題 / 伺服器錯誤）
    ↓
系統自動顯示「手動輸入面板」
    ↓
使用者填寫：
  - 銀行代號: bot (下拉選單)
  - 公司統編: 50660688
  - 使用者帳號: locker1688
  - 使用者密碼: Aa16881688
    ↓
點擊「使用手動輸入開始自動化」
    ↓
系統開始運作...（與方式 A 相同）
```

### 情境 3: 取消手動輸入

```
API 失敗 → 顯示手動輸入面板
    ↓
使用者點擊「取消」
    ↓
手動輸入面板隱藏
    ↓
使用者可重新嘗試「獲取登入資訊」
```

## UI 狀態轉換

### 初始狀態

```
┌─────────────────────────┐
│ 1. 設定與查詢            │
│ [銀行編號: 101]          │
│ [獲取登入資訊] ← 可點擊   │
│ [查詢天數: 0]            │
└─────────────────────────┘

[銀行資訊面板] ← 隱藏
[手動輸入面板] ← 隱藏
[日誌區域] ← 顯示「系統已就緒」
```

### API 成功後

```
┌─────────────────────────┐
│ 1. 設定與查詢            │
│ [銀行編號: 101] ← 鎖定    │
│ [獲取登入資訊] ← 已成功   │
│ [查詢天數: 0]            │
└─────────────────────────┘

┌─────────────────────────┐
│ 2. 銀行資訊確認          │ ← 顯示
│ 銀行名稱: 臺灣銀行       │
│ 統編: 50660688          │
│ 使用者代號: locker1688   │
│ [開始執行自動化] ← 可點擊 │
└─────────────────────────┘

[手動輸入面板] ← 隱藏
```

### API 失敗後

```
┌─────────────────────────┐
│ 1. 設定與查詢            │
│ [銀行編號: 101]          │
│ [獲取登入資訊] ← 可重試   │
│ [查詢天數: 0]            │
└─────────────────────────┘

[銀行資訊面板] ← 隱藏

┌─────────────────────────┐
│ 手動輸入登入資訊         │ ← 顯示
│ ⚠️ API 查詢失敗         │
│ 請手動輸入登入資訊       │
│                         │
│ [公司統編]              │
│ [使用者帳號]            │
│ [使用者密碼]            │
│                         │
│ [使用手動輸入開始] ← 可點擊│
│ [取消]                  │
└─────────────────────────┘
```

### 自動化執行中

```
┌─────────────────────────┐
│ 1. 設定與查詢            │
│ [銀行編號: 101] ← 鎖定    │
│ [獲取登入資訊] ← 禁用     │
│ [查詢天數: 0] ← 鎖定      │
└─────────────────────────┘

┌─────────────────────────┐
│ 控制面板                │
│ [停止自動化] ← 顯示       │ ← 危險按鈕（紅色）
└─────────────────────────┘

┌─────────────────────────┐
│ 執行狀態日誌            │
│ [清除]                  │
│                         │
│ [09:30:15] 瀏覽器已啟動  │
│ [09:30:18] 已填寫統編... │
│ [09:30:20] 請輸入驗證碼  │
│ [09:30:35] 登入成功！    │
│ [09:30:40] 步驟 1: ...  │
│ ...                     │
└─────────────────────────┘
```

## 按鈕狀態邏輯

### 「獲取登入資訊」按鈕

| 狀態 | 條件 | 文字 |
|-----|------|-----|
| 可點擊 | 初始狀態 | 「獲取登入資訊」 |
| 載入中 | API 請求中 | 「查詢中...」 |
| 禁用 | 自動化執行中 | 「獲取登入資訊」 |

### 「開始執行自動化」按鈕

| 狀態 | 條件 |
|-----|------|
| 隱藏 | 初始狀態 / API 失敗 |
| 顯示 | API 成功獲取資料 |
| 隱藏 | 自動化執行中 |

### 「使用手動輸入開始自動化」按鈕

| 狀態 | 條件 |
|-----|------|
| 隱藏 | 初始狀態 / API 成功 |
| 顯示 | API 失敗 |
| 禁用 | 欄位未填寫完整 |

### 「停止自動化」按鈕

| 狀態 | 條件 |
|-----|------|
| 隱藏 | 初始狀態 / 自動化未執行 |
| 顯示 | 自動化執行中 |

## 資料流向

### API 模式

```
UI (index.html)
  ↓ 使用者輸入銀行編號 101
Renderer (renderer.js)
  ↓ electronAPI.fetchBankInfo(101)
Main Process (main.js)
  ↓ fetch('https://api.wapi.asia/payer/calls/water/user')
API Server
  ↓ 回傳 { CompanyNo, User, Pass, ... }
Main Process
  ↓ 返回給 Renderer
Renderer
  ↓ 顯示在 UI
UI
  ↓ 使用者點擊「開始執行自動化」
Renderer
  ↓ electronAPI.startAutomation({ bankData: apiData })
Main Process
  ↓ 啟動 Puppeteer
Puppeteer Browser
  ↓ 執行自動化流程
```

### 手動模式

```
UI (index.html)
  ↓ 使用者輸入銀行編號 101
Renderer (renderer.js)
  ↓ electronAPI.fetchBankInfo(101)
Main Process (main.js)
  ↓ fetch('https://api.wapi.asia/...')
  ↓ ❌ API 失敗
Main Process
  ↓ 返回 { success: false }
Renderer
  ↓ 顯示「手動輸入面板」
UI
  ↓ 使用者填寫：統編、帳號、密碼
  ↓ 點擊「使用手動輸入開始自動化」
Renderer
  ↓ 建構手動資料物件
  ↓ electronAPI.startAutomation({ bankData: manualData })
Main Process
  ↓ 啟動 Puppeteer（流程與 API 模式相同）
Puppeteer Browser
  ↓ 執行自動化流程
```

## 關鍵程式碼

### renderer.js - 手動輸入處理

```javascript
btnManualStart.addEventListener('click', () => {
    const bankCode = inputManualBankCode.value.trim(); // ← 新增：銀行代號
    const companyId = inputManualCompanyId.value.trim();
    const userId = inputManualUserId.value.trim();
    const password = inputManualPassword.value.trim();
    
    // 驗證輸入
    if (!bankCode) {
        addLog('請選擇銀行代號', 'error');
        return;
    }
    
    if (!companyId || !userId || !password) {
        addLog('請填寫完整的登入資訊', 'error');
        return;
    }
    
    // 根據銀行代號獲取銀行名稱
    const bankNames = {
        'bot': '臺灣銀行',
        'yuanta': '元大銀行',
        'hncb': '華南商銀',
        // ... 其他銀行
    };
    
    // 建構手動輸入的銀行資料（格式與 API 回傳一致）
    const manualBankData = {
        BankID: parseInt(inputBankId.value) || 101,
        BankName: bankNames[bankCode] || '未知銀行',
        CompanyNo: companyId,  // ← 使用 API 欄位名稱
        User: userId,          // ← 使用 API 欄位名稱
        Pass: password,        // ← 使用 API 欄位名稱
        ConfigKey: bankCode,   // ← 使用選擇的銀行代號
    };
    
    // 傳送給主進程（與 API 模式完全相同）
    window.electronAPI.startAutomation({
        bankData: manualBankData,
        settings: { queryDaysBack: queryDays }
    });
});
```

### bot.js - 統一的資料處理

```javascript
async autoFillLoginForm(loginData) {
    // 支援兩種來源的資料：
    // 1. API 回傳：CompanyNo, User, Pass
    // 2. 手動輸入：CompanyNo, User, Pass（格式相同）
    const companyId = String(loginData.CompanyNo || loginData.companyId || '');
    const userId = String(loginData.User || loginData.userId || '');
    const password = String(loginData.Pass || loginData.password || '');
    
    // 填寫表單...
}
```

## 優點

### 1. 靈活性
- ✅ API 正常時使用自動獲取（方便）
- ✅ API 失敗時可手動輸入（可靠）
- ✅ 兩種方式的後續流程完全相同

### 2. 使用者體驗
- ✅ 自動判斷顯示哪個面板
- ✅ 明確的錯誤提示
- ✅ 可取消手動輸入重新嘗試 API

### 3. 資料格式統一
- ✅ 手動輸入使用與 API 相同的欄位名稱
- ✅ 主進程無需區分資料來源
- ✅ 銀行模組無需修改

## 測試情境

### 測試 1: API 成功
1. 輸入 `101`
2. 點擊「獲取登入資訊」
3. 確認顯示銀行資訊
4. 點擊「開始執行自動化」
5. ✅ 應該正常啟動

### 測試 2: API 失敗 → 手動輸入
1. 輸入 `999`（不存在的銀行）
2. 點擊「獲取登入資訊」
3. 確認顯示手動輸入面板
4. 填寫登入資訊
5. 點擊「使用手動輸入開始自動化」
6. ✅ 應該正常啟動

### 測試 3: 取消手動輸入
1. API 失敗 → 顯示手動輸入面板
2. 點擊「取消」
3. ✅ 手動輸入面板隱藏
4. ✅ 可重新點擊「獲取登入資訊」

### 測試 4: 手動輸入驗證
1. 顯示手動輸入面板
2. 只填寫統編，不填帳號和密碼
3. 點擊「使用手動輸入開始自動化」
4. ✅ 應該顯示錯誤訊息「請填寫完整的登入資訊」

---

**文件版本**: v1.1  
**最後更新**: 2025-12-03  
**新增功能**: 手動輸入備援模式

