# 功能規格說明書

## 系統概述

本系統是一個基於 Electron 的桌面應用程式，用於自動化銀行交易明細的查詢與記錄。系統採用模組化架構，支援多間銀行的自動化操作。

## 支援的銀行

目前支援的銀行：
- ✅ **臺灣銀行 (BOT)** - 銀行代號：`bot`
- ✅ **合作金庫銀行 (COBANK)** - 銀行代號：`cobank`

## 核心功能

### 1. 登入自動化

#### 1.1 自動填寫登入表單

**功能描述**：
- 自動填入統一編號（公司統編）
- 自動填入使用者帳號
- 自動填入使用者密碼
- 支援從 API 獲取登入資訊或手動輸入

**實作邏輯**：
- 透過 API (`POST https://api.wapi.asia/payer/calls/water/user`) 獲取銀行登入資訊
- 欄位映射：`CompanyNo` → 統編，`User` → 帳號，`Pass` → 密碼
- 使用 Puppeteer 自動填寫表單欄位，模擬真人輸入速度（延遲 100ms）

**支援的銀行**：
- 臺灣銀行：主頁面表單
- 合作金庫：iframe 內表單（需額外處理彈窗頁面）

#### 1.2 驗證碼監聽與自動提交

**功能描述**：
- 監聽驗證碼輸入框
- 當驗證碼輸入完成（達到指定長度，通常為 4 位數）時，自動點擊登入按鈕
- 延遲 500ms 後執行登入，確保驗證碼完全輸入

**實作邏輯**：
- 在頁面上下文中注入事件監聽器
- 監聽 `input` 事件，檢查輸入長度
- 達到指定長度時觸發登入按鈕點擊
- 支援不同的登入按鈕選擇器（button、input[type="submit"]、a 標籤等）

#### 1.3 登入成功檢測

**功能描述**：
- 自動檢測登入是否成功
- 等待頁面跳轉或 DOM 元素出現
- 確認進入銀行主頁面後才執行後續步驟

**實作邏輯**：

**臺灣銀行**：
- 等待 URL 變更，檢測是否包含主頁面關鍵字（`cibmain.faces`、`main`）
- 等待 MainFrame iframe 完全載入（檢查 contentDocument 和 body 內容）
- 超時設定：120 秒（登入）+ 30 秒（iframe 載入）

**合作金庫**：
- URL 登入前後相同，需檢測 DOM 元素
- 檢查 iframe 內是否出現登入後元素（帳戶查詢標籤、登出按鈕、主頁面元素等）
- 至少需要找到 2 個登入後元素才確認登入成功
- 超時設定：180 秒

### 2. 查詢自動化

#### 2.1 導航到查詢頁面

**功能描述**：
- 自動導航到帳務查詢頁面
- 自動點擊相關選單項目

**實作邏輯**：

**臺灣銀行**：
1. 點擊「帳務查詢」連結（透過 ID `B2C::FAO` 或備用選擇器）
2. 點擊「存款帳戶」選單項目（展開子選單）
3. 點擊「交易明細查詢」項目（ID: `B2C::FAO01003`）
4. 直接設定 iframe1 的 location 以導航到查詢頁面

**合作金庫**：
1. 點擊「帳戶查詢」標籤（`label[for="top_menu_1"]`）
2. 點擊「存款查詢」按鈕（accordion 內的 button）
3. 點擊「交易明細查詢」項目（`.sub-item` 內包含「交易明細查詢」文字的 div）

#### 2.2 日期範圍設定

**功能描述**：
- 自動計算查詢日期範圍（根據查詢天數設定）
- 自動填入起始日期和結束日期
- 支援假日模式（臺灣銀行可選擇「僅查詢當日」）

**實作邏輯**：
- 使用 `utils.calculateDateRange(queryDaysBack)` 計算日期範圍
- 格式：`YYYY-MM-DD`（例如：`2025-12-06`）
- 支援查詢天數設定（0 = 僅查詢當日，1 = 查詢當日+前1天，以此類推）
- 假日檢測：使用 `utils.isHoliday()` 判斷是否為假日
- 觸發 `input` 和 `change` 事件以確保表單更新

**合作金庫額外設定**：
- 自動選擇第一個帳戶（戶名下拉選單）
- 自動選擇第一個帳號（帳號下拉選單）
- 自動選擇幣別 TWD（新臺幣）
- 點擊 From-To 日期選項（第一個 radio button）

#### 2.3 執行查詢

**功能描述**：
- 自動點擊查詢按鈕
- 等待查詢結果載入完成（檢測 loading overlay 消失）

**實作邏輯**：
- 點擊查詢按鈕（臺灣銀行：`form1:linkCommand`，合作金庫：包含「查詢」文字的按鈕）
- 等待 loading 消失（臺灣銀行：檢查 `js_overLayer` 元素的 display 狀態）
- 超時設定：60 秒（每秒檢查一次）

#### 2.4 交易資料提取

**功能描述**：
- 解析 HTML 表格，提取交易明細資料
- 提取欄位：日期時間、帳號、金額、餘額
- 支援多頁面處理（自動點擊下一頁）

**實作邏輯**：

**臺灣銀行**：
- 從 `form1:grid_DataGridBody` 表格中提取資料
- 日期處理：
  - 一般模式：只有日期（如 `2025/12/06`），需補上時間（當日使用當前時間，其他日期使用 23:59:00）
  - 假日模式：完整日期時間（如 `2025/12/05 15:50:19`）
- 帳號處理：從「對方帳號」欄位提取銀行代碼（3碼）和帳號（16碼），組合為完整帳號
- 金額處理：提取「存入」欄位，移除千分位逗號
- 餘額處理：提取「結餘金額」欄位（假日模式無此欄位）

**合作金庫**：
- 從 `table.tb_multi` 表格中提取資料
- 日期處理：從 HTML 中解析日期和時間（格式：`YYYY/MM/DD HH:mm:ss`）
- 帳號處理：
  - 從「摘要/交易行庫」欄位識別銀行名稱
  - 使用銀行名稱到代碼的映射表轉換為銀行代碼
  - 從「備註/支票號碼」欄位提取帳號（16碼或13碼）
  - 組合為完整帳號：銀行代碼（3碼）+ 帳號（16碼）
  - 同行轉帳（合庫）使用銀行代碼 006
- 金額處理：提取「存款金額」欄位（第5欄）
- 餘額處理：提取「餘額」欄位（第6欄）

**資料格式**：
```javascript
{
  date: "2025/12/06 14:30:00",  // 完整日期時間
  account: "8220000428540937901", // 完整帳號（銀行代碼3碼 + 帳號16碼）
  amount: "10000",                // 金額（字串，已移除逗號）
  balance: "150000",              // 餘額（字串，已移除逗號）
  bankCode: "822",                // 銀行代碼（合作金庫）
  bankName: "中國信託",            // 銀行名稱（合作金庫）
  rowIndex: 1,                    // 行索引
  isHoliday: false                // 是否為假日模式（臺灣銀行）
}
```

#### 2.5 多頁面處理

**功能描述**：
- 自動檢測是否有下一頁
- 自動點擊下一頁按鈕
- 遞迴提取所有頁面的交易資料

**實作邏輯**：
- 檢查下一頁按鈕是否存在且未被禁用
- 點擊下一頁後等待頁面載入
- 遞迴呼叫提取函數處理下一頁資料
- 直到沒有下一頁為止

### 3. 資料處理與 API 整合

#### 3.1 批次檢查重複記錄

**功能描述**：
- 在發送交易記錄前，批次檢查哪些記錄已存在
- 過濾掉已存在的記錄，避免重複發送

**實作邏輯**：
- API 端點：`POST https://cz-backend.vercel.app/api/transactions/check`
- 請求格式：
  ```json
  {
    "items": [
      {
        "bank_id": 101,
        "balance": 150000,
        "carder": "8220000428540937901",
        "pay": 10000
      }
    ]
  }
  ```
- 特殊處理（臺灣銀行假日模式）：
  - 只使用 `balance` 和 `time` 欄位檢查
  - 其他模式使用 `balance`、`carder`、`pay` 欄位檢查
- 回應格式：
  ```json
  {
    "success": true,
    "data": [
      {
        "balance": 150000,
        "is_exist": true
      }
    ]
  }
  ```
- 建立 balance → is_exist 的映射表，用於快速查詢

#### 3.2 發送交易記錄到 API

**功能描述**：
- 將提取的交易記錄發送到後端 API
- 支援進度回調，顯示發送進度
- 處理重複記錄（發送前即時檢查）
- 限制最多處理 600 筆

**實作邏輯**：

**步驟 1：批次檢查重複**
- 呼叫 `/api/transactions/check` 批次檢查所有記錄
- 過濾掉已存在的記錄

**步驟 2：限制處理數量**
- 最多處理 600 筆新記錄
- 超過 600 筆時，只處理前 600 筆，並記錄警告

**步驟 3：逐筆發送**
1. **即時檢查**（避免重複）：
   - 每筆發送前再次檢查是否已存在
   - 使用 `/api/transactions/check` API
   - 如已存在則跳過

2. **發送到 /order API**：
   - API 端點：`POST https://api.wapi.asia/payer/calls/water/order`
   - 請求格式：
     ```json
     {
       "Carder": "8220000428540937901",  // 處理後格式：前3碼 + 後7碼
       "Pay": 10000,
       "Time": "2025/12/06 14:30:00",
       "BankID": 101,
       "Balance": 150000
     }
     ```
   - 帳號處理：只保留前 3 碼和後 7 碼（`Carder.slice(0, 3) + Carder.slice(-7)`）
   - 回應格式：
     ```json
     {
       "Code": 1,  // 1 = 成功
       "Aid": "12345678"  // 交易 ID
     }
     ```

3. **發送到 /api/transactions API**（存入資料庫）：
   - API 端點：`POST https://cz-backend.vercel.app/api/transactions`
   - 請求格式：
     ```json
     {
       "aid": "12345678",
       "carder": "8220000428540937901",
       "pay": 10000,
       "time": "2025/12/06 14:30:00",
       "bank_id": 101,
       "balance": 150000
     }
     ```
   - 只有 /order API 成功時才發送

**進度回調**：
- 每筆發送後呼叫進度回調函數
- 參數：`(current, total, success, error)`
- 用於 UI 顯示發送進度

**請求間隔**：
- 每筆請求間隔 500ms，避免過快請求

**返回結果**：
```javascript
{
  successCount: 50,    // 成功筆數
  errorCount: 0,       // 失敗筆數
  totalCount: 50,      // 處理總筆數
  skippedCount: 10     // 跳過筆數（已存在）
}
```

### 4. 循環查詢機制

#### 4.1 自動重新查詢

**功能描述**：
- 完成一次查詢後，等待指定時間後自動重新查詢
- 持續循環執行，直到手動停止

**實作邏輯**：
- 臺灣銀行：預設等待 5 秒後重新查詢
- 合作金庫：預設等待 5 分鐘（300 秒）後重新查詢
- 重新查詢時：
  1. 點擊重新查詢按鈕回到設定頁面
  2. 重新設定日期範圍（使用調整後的查詢天數）
  3. 執行查詢
  4. 提取資料
  5. 遞迴呼叫，繼續下一輪循環

#### 4.2 跨日處理

**功能描述**：
- 檢測是否跨越到新的一天
- 在新的一天的前 10 分鐘內（00:00 - 00:10），暫時調整查詢天數為 1
- 避免漏掉昨天深夜的交易記錄

**實作邏輯**：
- 記錄上次查詢日期
- 每次重新查詢前檢查：
  - 當前日期是否與上次查詢日期不同（跨日）
  - 當前時間是否在前 10 分鐘內（`currentHour === 0 && currentMinute < 10`）
- 如果符合條件，將查詢天數暫時調整為 1
- 記錄原始查詢天數，以便後續恢復（目前實作中未恢復，每次檢查都會重新計算）

**範例**：
- 原始查詢天數：0（僅查詢當日）
- 跨日且在前 10 分鐘內：調整為 1（查詢當日+前1天）
- 10 分鐘後或非跨日：使用原始設定 0

### 5. 線上狀態管理

#### 5.1 線上狀態 API 定時器

**功能描述**：
- 定時發送線上狀態 API，告知後端系統正在運行
- 確保後端能追蹤系統狀態

**實作邏輯**：
- API 端點：`POST https://api.wapi.asia/payer/calls/water/online`
- 請求格式：
  ```json
  {
    "BankID": 101
  }
  ```
- 定時器設定：
  - 間隔：每 2 分鐘（120,000 毫秒）
  - 啟動時立即呼叫一次
  - 後續每 2 分鐘自動呼叫一次
- 啟動時機：登入成功後，開始執行自動化流程時
- 停止時機：自動化流程結束或錯誤時

### 6. 錯誤處理與日誌

#### 6.1 日誌系統

**功能描述**：
- 記錄自動化執行的每一步狀態
- 支援不同日誌等級（info、success、error、system）
- 即時顯示在 UI 上

**日誌等級**：
- `info`：一般資訊
- `success`：成功操作
- `error`：錯誤訊息
- `system`：系統訊息（重要操作）

**日誌格式**：
```
[BANK-LEVEL] 訊息內容
```
例如：`[BOT-INFO] 開始填寫登入表單...`

#### 6.2 錯誤處理

**功能描述**：
- 捕獲並記錄錯誤
- 顯示詳細錯誤訊息（包含堆疊資訊）
- 部分錯誤不會中斷流程（如截圖失敗）

**錯誤類型**：
1. **登入相關錯誤**：
   - 表單元素找不到
   - 登入超時
   - 驗證碼監聽器啟動失敗

2. **查詢相關錯誤**：
   - 頁面元素找不到
   - 查詢超時
   - 資料提取失敗

3. **API 相關錯誤**：
   - API 請求失敗
   - 回應格式錯誤
   - 網路連線錯誤

4. **其他錯誤**：
   - iframe 訪問失敗（跨域限制）
   - 頁面載入超時

### 7. 暫停與恢復機制

#### 7.1 暫停功能

**功能描述**：
- 支援暫停自動化流程
- 在等待重新查詢時檢查暫停狀態
- 暫停時不執行任何自動化操作

**實作邏輯**：
- 使用 `isPaused` 標記追蹤暫停狀態
- 在 `waitAndRequery` 函數中分段等待，每秒檢查一次暫停狀態
- 如果被暫停，進入等待循環，直到恢復
- 恢復後繼續執行

### 8. 特殊功能

#### 8.1 假日模式（臺灣銀行）

**功能描述**：
- 自動檢測是否為假日
- 假日時使用「僅查詢當日」選項
- 假日模式的資料提取邏輯不同（沒有餘額欄位）

**實作邏輯**：
- 使用 `utils.isHoliday()` 判斷是否為假日
- 假日時點擊 `form1:queryType3`（僅查詢當日選項）
- 假日模式的資料提取：
  - 日期時間為完整格式（包含時分秒）
  - 沒有餘額欄位（`balance` 為空字串）
  - 檢查 API 時使用 `balance` 和 `time` 欄位

#### 8.2 截圖調試功能

**功能描述**：
- 支援保存調試截圖
- 用於排查自動化流程問題

**實作邏輯**：
- 提供 `takeDebugScreenshot(stepName)` 方法
- 保存完整頁面截圖
- 檔名格式：`debug_{stepName}_{timestamp}.png`
- 預設未啟用，需要在代碼中取消註解

## 技術架構

### 使用的技術

1. **Electron**：桌面應用程式框架
2. **Puppeteer**：瀏覽器自動化引擎
3. **puppeteer-extra-plugin-stealth**：反偵測插件
4. **Node.js**：後端運行環境

### 模組化架構

每個銀行模組包含：
- **config 物件**：靜態配置（URL、選擇器、步驟定義等）
- **Automation 類別**：自動化邏輯實作

### API 端點

1. **獲取銀行資訊**：
   - `POST https://api.wapi.asia/payer/calls/water/user`
   - 參數：`{ BankID: number }`

2. **發送交易記錄（訂單）**：
   - `POST https://api.wapi.asia/payer/calls/water/order`
   - 參數：`{ Carder, Pay, Time, BankID, Balance }`

3. **檢查交易記錄是否存在**：
   - `POST https://cz-backend.vercel.app/api/transactions/check`
   - 參數：`{ items: Array }`

4. **存入交易記錄**：
   - `POST https://cz-backend.vercel.app/api/transactions`
   - 參數：`{ aid, carder, pay, time, bank_id, balance }`

5. **線上狀態**：
   - `POST https://api.wapi.asia/payer/calls/water/online`
   - 參數：`{ BankID: number }`

## 限制與注意事項

1. **驗證碼**：目前需要手動輸入驗證碼，系統自動監聽並提交
2. **處理數量限制**：最多處理 600 筆新交易記錄
3. **請求間隔**：每筆 API 請求間隔 500ms
4. **超時設定**：
   - 登入等待：120-180 秒
   - iframe 載入：30 秒
   - 查詢載入：60 秒
5. **跨日處理**：僅在新的一天前 10 分鐘內調整查詢天數
6. **線上狀態更新**：每 2 分鐘更新一次

## 未來擴充

系統設計支援未來新增更多銀行：
- 在 `src/banks/` 目錄下新增銀行模組檔案
- 在 `src/banks/index.js` 中註冊新銀行
- 更新 `bankNameMap` 映射表

目前已規劃但尚未實作的銀行（參考 `src/banks/index.js`）：
- 元大銀行
- 華南銀行
- 玉山銀行
- 陽信銀行
- 京城銀行
- 第一銀行
- 國泰世華
- 中國信託
- 其他多家銀行...
